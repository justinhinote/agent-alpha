name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.30.2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Format check
        run: pnpm format:check

      - name: Typecheck
        run: pnpm typecheck

      - name: Test
        run: pnpm test

      - name: Build
        run: pnpm build

  snapshot_artifacts:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: validate
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.30.2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Resolve previous successful CI run on main
        id: previous_run
        uses: actions/github-script@v7
        with:
          script: |
            const currentRunId = Number(process.env.GITHUB_RUN_ID);
            const { owner, repo } = context.repo;
            const { data } = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: "ci.yml",
              branch: "main",
              event: "push",
              status: "completed",
              per_page: 50
            });

            const previous = (data.workflow_runs ?? []).find(
              (run) => run.id !== currentRunId && run.conclusion === "success"
            );

            if (previous) {
              core.info(`Using previous successful run ${previous.id} (${previous.head_sha})`);
              core.setOutput("run_id", String(previous.id));
            } else {
              core.info("No previous successful run found on main; generating baseline snapshot.");
              core.setOutput("run_id", "");
            }

      - name: Download previous snapshot artifacts
        if: steps.previous_run.outputs.run_id != ''
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ github.token }}
          repository: ${{ github.repository }}
          run-id: ${{ steps.previous_run.outputs.run_id }}
          pattern: snapshot-report-*
          path: docs/reports
          merge-multiple: true

      - name: Generate snapshot report artifacts
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
        run: pnpm start -- snapshot-report --path docs/reports --format both --repo "${{ github.repository }}"

      - name: Upload snapshot report artifacts
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-report-${{ github.sha }}
          path: docs/reports/snapshot-report-*
          if-no-files-found: error
          retention-days: 14
